---
title: "Untitled"
author: "Ashirwad Barnwal"
date: '2022-03-25'
output: html_document
---

# Getting setup
Define setup chunk:

```{r setup}
# Elegant handling of namespace conflicts
library(conflicted)

# Path & data manipulation
library(here)
library(tidyverse)
conflict_prefer("filter", "dplyr")
```

# Data preparation

## Import data
Import IST data:

```{r ist-raw, message = FALSE, warning = FALSE}
ist_raw <- read_csv(here("data", "IST_corrected.csv"))
glimpse(ist_raw)
```

## Clean data
Clean IST data:

```{r ist}
ist <- ist_raw %>%
  select(RDELAY:STYPE, RXASP, RXHEP, OCCODE) %>%
  mutate(
    RXHEP = fct_collapse(RXHEP, "M" = c("M", "H")),
    treatment = case_when(
      RXASP == "N" & RXHEP == "N" ~ "no_asp_no_hep",
      RXASP == "N" & RXHEP == "L" ~ "no_asp_low_hep",
      RXASP == "N" & RXHEP == "M" ~ "no_asp_med_hep",
      RXASP == "Y" & RXHEP == "N" ~ "yes_asp_no_hep",
      RXASP == "Y" & RXHEP == "L" ~ "yes_asp_low_hep",
      RXASP == "Y" & RXHEP == "M" ~ "yes_asp_med_hep"
    ),
    treatment = fct_relevel(treatment, "no_asp_no_hep") %>%
      fct_relevel("yes_asp_no_hep", after = 3),
    OCCODE = recode(
      OCCODE, `1` = "dead", `2` = "dependent", `3` = "not_recovered", 
      `4` = "recovered", .default = "missing"
    ),
    dead_or_dep = case_when(
      OCCODE %in% c("dead", "dependent") ~ "yes",
      OCCODE %in% c("not_recovered", "recovered") ~ "no",
      OCCODE == "missing" ~ "missing"
    ) %>% 
      fct_relevel("no")
  ) %>%
  select(-RXASP, -RXHEP, -OCCODE) %>%
  mutate(across(where(is.character), ~ as.factor(.x)))
glimpse(ist)
```


