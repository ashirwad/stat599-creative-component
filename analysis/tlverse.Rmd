---
title: "Stroke trial modeling result"
author: "Ashirwad Barnwal"
date: "10/21/2020"
output: html_document
---

```{r before-doc, cache = FALSE}
knitr::opts_chunk$set(
  cache = TRUE, 
  autodep = TRUE
)
```

# Getting setup
Define setup chunk:

```{r setup, message = FALSE, warning = FALSE, cache = FALSE}
# Elegant handling of namespace conflicts
library(conflicted)

# Miscellaneous
library(default)
library(tictoc)
doParallel::registerDoParallel()

# Path & data manipulation
library(here)
library(tidyverse)
conflict_prefer("filter", "dplyr")

# Model building & evaluation
library(tidymodels)
library(stacks)

# Pretty tables
library(summarytools)
st_options(
  style = "rmarkdown",
  plain.ascii = FALSE,
  footnote = NA,
  dfSummary.style = "grid",
  dfSummary.valid.col = FALSE,
  dfSummary.graph.magnif = 0.75,
  tmp.img.dir = "/img",
  subtitle.emphasis = FALSE
)

# My functions
pull_entry <- function(in_data, trt_type, col_name) {
  in_data %>%
    filter(treatment == trt_type) %>%
    pluck(col_name, 1)
}
```

```{r st-css, echo = FALSE, results = "asis"}
st_css()
```

# International Stroke Trial (IST) data

## Import data
Import IST data:

```{r ist-raw, message = FALSE, warning = FALSE}
ist_raw <- read_csv(here("data", "IST_corrected.csv"))
glimpse(ist_raw)
```

## Subset data {.tabset}
Create a subset of IST data for model building:

```{r ist}
ist <- ist_raw %>%
  select(RDELAY:STYPE, RXASP, RXHEP, FDEAD) %>%
  mutate(
    RXHEP = fct_collapse(RXHEP, "M" = c("M", "H")),
    treatment = case_when(
      RXASP == "N" & RXHEP == "N" ~ "no_asp_no_hep",
      RXASP == "N" & RXHEP == "L" ~ "no_asp_low_hep",
      RXASP == "N" & RXHEP == "M" ~ "no_asp_med_hep",
      RXASP == "Y" & RXHEP == "N" ~ "yes_asp_no_hep",
      RXASP == "Y" & RXHEP == "L" ~ "yes_asp_low_hep",
      RXASP == "Y" & RXHEP == "M" ~ "yes_asp_med_hep"
    )
  ) %>%
  select(-RXASP, -RXHEP)
glimpse(ist)
```

Create six data frames, one for each treatment group:

```{r ist-fdead}
ist_fdead <- ist %>%
  filter(FDEAD != "U") %>%
  drop_na(RATRIAL, FDEAD) %>%
  group_by(treatment) %>%
  nest() %>%
  ungroup()
glimpse(ist_fdead)
```

Generate descriptive summaries for data corresponding to each treatment group:

```{r ist-fdead-smry, message = FALSE}
ist_fdead_smry <- ist_fdead %>%
  mutate(
    df_summary = map(data, ~ dfSummary(.x))
  )
glimpse(ist_fdead_smry)
```

### Treatment A: No aspirin, no heparin
Glimpse data:

```{r ist-fdead-nasp-nhep}
pull_entry(ist_fdead, "no_asp_no_hep", "data") %>%
  glimpse()
```

View data summary:

```{r ist-fdead-nasp-nhep-smry, results = "asis"}
pull_entry(ist_fdead_smry, "no_asp_no_hep", "df_summary") %>%
  print(max.tbl.height = 600, method = "render")
```

### Treatment B: No aspirin, low heparin
Glimpse data:

```{r ist-fdead-nasp-lhep}
pull_entry(ist_fdead, "no_asp_low_hep", "data") %>%
  glimpse()
```

View data summary:

```{r ist-fdead-nasp-lhep-smry, results = "asis"}
pull_entry(ist_fdead_smry, "no_asp_low_hep", "df_summary") %>%
  print(max.tbl.height = 600, method = "render")
```

### Treatment C: No aspirin, medium heparin
Glimpse data:

```{r ist-fdead-nasp-mhep}
pull_entry(ist_fdead, "no_asp_med_hep", "data") %>%
  glimpse()
```

View data summary:

```{r ist-fdead-nasp-mhep-smry, results = "asis"}
pull_entry(ist_fdead_smry, "no_asp_med_hep", "df_summary") %>%
  print(max.tbl.height = 600, method = "render")
```

### Treatment D: aspirin, no heparin
Glimpse data:

```{r ist-fdead-asp-nhep}
pull_entry(ist_fdead, "yes_asp_no_hep", "data") %>%
  glimpse()
```

View data summary:

```{r ist-fdead-asp-nhep-smry, results = "asis"}
pull_entry(ist_fdead_smry, "yes_asp_no_hep", "df_summary") %>%
  print(max.tbl.height = 600, method = "render")
```

### Treatment E: aspirin, low heparin
Glimpse data:

```{r ist-fdead-asp-lhep}
pull_entry(ist_fdead, "yes_asp_low_hep", "data") %>%
  glimpse()
```

View data summary:

```{r ist-fdead-asp-lhep-smry, results = "asis"}
pull_entry(ist_fdead_smry, "yes_asp_low_hep", "df_summary") %>%
  print(max.tbl.height = 600, method = "render")
```

### Treatment F: aspirin, medium heparin
Glimpse data:

```{r ist-fdead-asp-mhep}
pull_entry(ist_fdead, "yes_asp_med_hep", "data") %>%
  glimpse()
```

View data summary:

```{r ist-fdead-asp-mhep-smry, results = "asis"}
pull_entry(ist_fdead_smry, "yes_asp_med_hep", "df_summary") %>%
  print(max.tbl.height = 600, method = "render")
```

## Data partitioning
Create data partitions:

```{r ist-splits}
# For reproducible results
set.seed(123)

# Data partitions
ist_fdead_nasp_nhep <- pull_entry(ist_fdead, "no_asp_no_hep", "data") %>%
  mutate(across(where(is.character), as.factor))
ist_split <- initial_split(ist_fdead_nasp_nhep, strata = FDEAD)
ist_train <- training(ist_split)
ist_test <- testing(ist_split)

ist_folds <- vfold_cv(ist_train, v = 5)
```

## Model specification {.tabset}

### Random forest
Specify a random forest model:

```{r rf-spec}
rf_spec <- rand_forest(
  mtry = tune(),
  trees = 500,
  min_n = tune()
) %>%
  set_mode("classification") %>%
  set_engine("ranger")
rf_spec
```

### Neural network
Specify a neural network model:

```{r nnet-spec}
nnet_spec <- mlp(hidden_units = tune(), penalty = tune(), epochs = tune()) %>%
  set_mode("classification") %>%
  set_engine("nnet")
nnet_spec
```

### XGBoost
Specify an XGBoost model:

```{r xgb-spec}
xgb_spec <- boost_tree(
  mtry = tune(),
  trees = 1000,
  min_n = tune(),
  tree_depth = tune(),
  learn_rate = tune(),
  loss_reduction = tune(),
  sample_size = tune()
) %>%
  set_mode("classification") %>%
  set_engine("xgboost")
xgb_spec
```

## Feature engineering {.tabset}
Define recipes for feature engineering:

### Dummy coding
Create dummy variables:

```{r base-rec}
base_rec <- recipe(FDEAD ~ ., data = ist_train) %>%
  step_dummy(all_nominal(), -all_outcomes())
base_rec
```

### Normalization
Center and scale numeric variables:

```{r norm-rec}
norm_rec <- base_rec %>%
  step_normalize(all_predictors())
norm_rec
```

## Modeling workflow {.tabset}
Specify modeling workflows:

### Random forest
Specify a modeling workflow for random forest:

```{r rf-wflow}
rf_wflow <- workflow() %>%
  add_recipe(base_rec) %>%
  add_model(rf_spec)
rf_wflow
```

### Neural network
Specify a modeling workflow for neural net:

```{r nnet-wflow}
nnet_wflow <- workflow() %>%
  add_recipe(norm_rec) %>%
  add_model(nnet_spec)
nnet_wflow
```

### XGBoost
Specify a modeling workflow for XGBoost:

```{r xgb-wflow}
xgb_wflow <- workflow() %>%
  add_recipe(base_rec) %>%
  add_model(xgb_spec)
xgb_wflow
```

## Model tuning {.tabset}
Define control settings for data stacking:

```{r cntrl-grid}
cntrl_grid <- control_stack_grid()
cntrl_grid
```

### Random forest
Tune random forest model:

```{r rf-res}
tic()
set.seed(345)
rf_res <- tune_grid(
  object = rf_wflow,
  resamples = ist_folds,
  grid = 10,
  control = cntrl_grid
)
toc()
rf_res
```

### Neural network
Tune neural net model:

```{r nnet-res}
tic()
set.seed(123)
nnet_res <- tune_grid(
  object = nnet_wflow,
  resamples = ist_folds,
  grid = 10,
  control = cntrl_grid
)
toc()
nnet_res
```

### XGBoost
Construct parameter grid:

```{r xgb-grid}
xgb_grid <- grid_latin_hypercube(
  min_n(),
  tree_depth(),
  learn_rate(),
  loss_reduction(),
  sample_size = sample_prop(),
  finalize(mtry(), ist_train),
  size = 30
)
xgb_grid
```

Tune XGBoost model:

```{r xgb-res}
tic()
set.seed(123)
xgb_res <- tune_grid(
  object = xgb_wflow,
  resamples = ist_folds,
  grid = xgb_grid,
  control = cntrl_grid
)
toc()
xgb_res
```

