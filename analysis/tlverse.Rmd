---
title: "Untitled"
author: "Ashirwad Barnwal"
date: "10/21/2020"
output: html_document
---

# Getting setup
Define setup chunk:

```{r setup, message = FALSE}
# Elegant handling of namespace conflicts
library(conflicted)

# Core tidyverse
library(tidyverse)

# Model building & evaluation
library(sl3)
library(origami)
library(ROCR)

# Pretty tables
library(summarytools)
```

Include `summarytools`' *css*:

```{r st-css, results = "asis"}
st_css()
```

# Think a heading

## International Stroke Trial (IST) data
Import IST data:

```{r}
ist_sample <- read_csv(
  "https://raw.githubusercontent.com/tlverse/tlverse-handbook/master/data/ist_sample.csv"
)
glimpse(ist_sample)
```

## Study design recap
Here's a quick recap of the study design:

```{r subj-count-by-treatment}
(subj_count_by_treatment <- ist_sample %>%
  mutate(across(c(RXASP, RXHEP), as.factor)) %$%
  ctable(RXASP, RXHEP) %>%
  print(method = "render"))
```

# Build prediction models

## Machine learning task
Define a machine learning task:

```{r ml-task}
(ml_task <- make_sl3_Task(
  data = ist_sample, 
  covariates = colnames(ist_sample)[!colnames(ist_sample) == "DRSISC"],
  outcome = "DRSISC",
  drop_missing_outcome = TRUE
))
```

## Learner library
Define learners to fit different machine learning algorithms:

```{r learner-library}
lrnr_glm <- Lrnr_glm$new()
lrnr_lasso <- Lrnr_glmnet$new(alpha = 1)
lrnr_ridge <- Lrnr_glmnet$new(alpha = 0)
lrnr_enet <- Lrnr_glmnet$new(alpha = 0.5)
lrnr_mean <- Lrnr_mean$new()
lrnr_ranger <- Lrnr_ranger$new()
lrnr_svm <- Lrnr_svm$new()
```

Handle xgboost separately:

```{r xgb-learners}
xgb_grid <- expand_grid(max_depth = c(2, 5, 8), eta = c(0.01, 0.15, 0.3))
params_default <- list(nthread = getOption("sl.cores.learners", 1))

xgb_learners <- apply(
  xgb_grid, MARGIN = 1, function(params_tune) {
    do.call(Lrnr_xgboost$new, c(params_default, as.list(params_tune)))
  }
)
```

Combine all learners:

```{r learners}
learners <- list(
  lrnr_glm, lrnr_lasso, lrnr_ridge, lrnr_enet, lrnr_mean, lrnr_ranger, lrnr_svm,
  xgb_learners
) %>%
  unlist()
```

## Model fitting
Define a super learner and train the model:

```{r sl-fit}
sl <- Lrnr_sl$new(learners)
sl_fit <- sl$train(ml_task)
```











